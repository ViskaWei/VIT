# VIT Project

Vision Transformer (ViT) models for spectral data using PyTorch Lightning and Hugging Face's transformers.

## ğŸš€ Quick Start

```bash
# Initialize environment
source init.sh

# Run 4 basic experiments (vit, att, pca, zpca)
./run_suite.sh basic

# Or run a single experiment
./launch.sh run --config configs/vit.yaml -g 0
```

## ğŸ“– Documentation

- **[USAGE_GUIDE.md](USAGE_GUIDE.md)** - å®Œæ•´çš„è¿è¡ŒæŒ‡å—å’Œå‘½ä»¤å‚è€ƒ
- **[BIAS_QUICK_START.md](BIAS_QUICK_START.md)** - ZCA Biaså¯¹æ¯”å®éªŒå¿«é€ŸæŒ‡å—
- **[configs/exp/README.md](configs/exp/README.md)** - å®éªŒé…ç½®è¯´æ˜
- **[test/README.md](test/README.md)** - Test suite documentation and guidelines
- **[TEST_CLEANUP_SUMMARY.md](TEST_CLEANUP_SUMMARY.md)** - Recent test cleanup summary

## ğŸ§ª Testing

Run the test suite:
```bash
pytest                    # Run all tests
pytest -m unit           # Run only unit tests
pytest -m "not slow"     # Skip slow tests
pytest --cov=src         # Run with coverage
```

See [test/README.md](test/README.md) for detailed testing documentation.

## Repository Overview

The project centers on building and training Vision Transformer (ViT)â€“style models for spectral data using PyTorch Lightning and Hugging Face's transformers. It is organized as follows:pository Overview
The project centers on building and training Vision Transformer (ViT)â€“style models for spectral data using PyTorchâ€¯Lightning and Hugging Faceâ€™s transformers. It is organized as follows:

| Path       | Purpose                                                                                                                      |
| ---------- | ---------------------------------------------------------------------------------------------------------------------------- |
| `src/`     | Core Python modules: dataset abstractions, model definitions, training loops, plotting utilities, and miscellaneous helpers. |
| `scripts/` | CLI entry points for launching experiments.                                                                                  |
| `configs/` | YAML configuration files describing model hyperparameters, data paths, optimization, etc.                                    |
| `evals/`   | Jupyter notebooks and other evaluation artifacts.                                                                            |

# Key Components

## 1. Training Workflow

* **Entry point:** `scripts/run.py` parses command-line arguments, loads a YAML config, and instantiates `Experiment`.
* **Experiment** (in `src/vit.py` or `src/blindspot.py`) combines a `LightningModule`, a `DataModule`, and a `Trainer`:

  * Builds model (`ViTLModule`) and dataset (`ViTDataModule`).
  * Optionally sets up Weights & Biases logging.
  * Executes training and testing.

## 2. Data Handling

* **`basemodule.py`** defines reusable mixins and base classes:

  * `Configurable` extracts constructor arguments from a config dictionary.
  * `BaseDataset`, `BaseDataModule` manage I/O from HDF5 files, masking/noise routines, and train/val/test splits.
  * `NoiseMixin`, `MaskMixin` encapsulate noise injection and masking logic.
* **`blindspot.py`** and **`vit.py`** implement dataset subclasses tailored to particular experiments.

## 3. Models

* **`model.py`** wraps Hugging Faceâ€™s `ViTForImageClassification`:

  * Custom patch embeddings (`MyCNN1DPatchEmbeddings`, `MyWindowPatchEmbeddings`) for 1-D spectra.
  * `MyEmbeddings` supports different positional encodings.
* **`vit.py`** constructs a `ViTLModule` that:

  * Uses the custom `MyViT` model.
  * Logs losses/metrics (`Accuracy` from `torchmetrics`) during train/val/test.

## 4. Training Logic

* **`train.py`** (alternative CLI) shows a full command-line interface for experimentation without config files.
* **`BaseLightningModule`** & **`BaseTrainer`** (in `basemodule.py`) wrap PyTorch Lightning conveniences (checkpointing, early stopping, optimizer/scheduler setup via `OptModule`).

## 5. Plotting & Evaluation

* **`plotter.py`** produces spectral plots, SNR comparisons, and equivalent-width analyses using `matplotlib`/`seaborn`.
* **`utils.py`** offers a large collection of helpers for spectral line manipulation, noise generation, SVD denoising, and various physical conversions.

## Data

Data generated by Laszlo & Balzsh:
```
/datascope/subaru/user/swei20/data/bosz50000/z0/train_1k

./bin/sim model bosz pfs --threads 24 --config /datascope/subaru/user/swei20/data/bosz50000/z0/train.json /datascope/subaru/user/swei20/data/bosz50000/z0/inst_pfs_mr.json --out /datascope/subaru/user/swei20/data/bosz50000/z0/test_1k --sample-count 1000 --seeing 0.5 1.5
```

# ============================================
# ViT 模型训练配置文件 - 完整版
# ============================================
# 本文件包含所有可调参数及其选项说明
# 使用方法: python scripts/run.py -f configs/config.yaml

# ============================================
# 项目配置
# ============================================
project: 'vit-viz'  # W&B项目名称，可选任意字符串

# ============================================
# 模型架构配置
# ============================================
model:
  name: vit  # 模型名称，目前只支持 'vit'
  
  # 任务类型: 'cls' (分类) 或 'reg' (回归)
  task_type: reg
  
  # 图像尺寸 (光谱长度)
  # 选项: 任意正整数，通常是2的幂次: 1024, 2048, 4096, 8192
  image_size: 4096
  
  # Patch大小 (每个token包含的连续点数)
  # 选项: 8, 16, 32, 64, 128, 256
  # 注意: image_size 必须能被 patch_size 整除（如果stride=patch）
  patch_size: 32
  
  # 隐藏层维度 (transformer embedding维度)
  # 选项: 16, 32, 64, 128, 256, 512, 768, 1024
  # 注意: 需要能被 num_attention_heads 整除
  hidden_size: 32
  
  # Transformer层数
  # 选项: 1-12，常用值: 2, 3, 4, 6, 8, 12
  num_hidden_layers: 2
  
  # 注意力头数
  # 选项: 1, 2, 4, 8, 16
  # 注意: hidden_size 必须能被 num_attention_heads 整除
  num_attention_heads: 2
  
  # 滑动窗口步长
  # 选项: 正整数，通常 <= patch_size
  # - stride_size = patch_size: 无重叠
  # - stride_size < patch_size: 有重叠，增加token数量
  stride_size: 32
  
  # 投影函数类型 (Patch Embedding方法)
  # 选项:
  #   - 'SW': 滑动窗口 (Sliding Window) - 简单快速
  #   - 'C1D' / 'CNN': 1D卷积 - 可学习特征提取
  proj_fn: 'SW'
  
  # 位置编码类型 (可选配置)
  # 选项:
  #   - null 或不设置: 无位置编码
  #   - 'learned': 可学习的绝对位置编码
  #   - 'rope': 旋转位置编码 (RoPE) - 更好的长度泛化
  # pos_encoding_type: null
  
  # RoPE基数 (仅当 pos_encoding_type='rope' 时使用)
  # 选项: 1000.0, 10000.0, 100000.0
  # rope_base: 10000.0
  
  # 最大位置数 (仅当使用位置编码时)
  # 选项: 512, 1024, 2048, 4096
  # max_position_embeddings: 512
  
  # 输出标签数 (回归任务时自动从data.param推导，无需手动设置)
  # num_labels: 1

# ============================================
# 训练配置
# ============================================
train:
  # 批量大小
  # 选项: 8, 16, 32, 64, 128, 256
  # 注意: 根据GPU内存调整
  batch_size: 64
  
  # 训练轮数
  # 选项: 任意正整数，常用: 5, 10, 20, 50, 100, 200
  ep: 5
  
  # 调试模式
  # 选项: 0 (关闭) 或 1 (开启)
  # 开启后会输出更多调试信息
  debug: 0
  
  # 是否保存检查点
  # 选项: true / false
  # 通过命令行 --save 参数覆盖
  save: false
  
  # 数据加载线程数
  # 选项: 0-8，常用: 0, 2, 4
  # num_workers: 2
  
  # GPU数量 (自动设置，无需手动配置)
  # gpus: 1

# ============================================
# 损失函数配置
# ============================================
loss:
  # 损失函数名称
  # 选项:
  #   回归任务: 'mae' / 'l1' (平均绝对误差), 'mse' / 'l2' (均方误差)
  #   分类任务: 'ce' (交叉熵，自动使用)
  name: 'mae'

# ============================================
# 优化器配置
# ============================================
opt:
  # 优化器类型
  # 选项: 'Adam', 'AdamW', 'SGD'
  type: 'AdamW'
  
  # 学习率
  # 选项: 0.0001 - 0.01，常用: 0.0001, 0.0003, 0.001, 0.003, 0.01
  lr: 0.001
  
  # 学习率调度器
  # 选项:
  #   - 'plateau': ReduceLROnPlateau - 验证指标不改善时降低学习率
  #   - 'cosine': CosineAnnealingLR - 余弦退火
  #   - 'step': StepLR - 固定步数降低
  #   - 'none' / null: 不使用调度器
  lr_sch: plateau
  
  # ReduceLROnPlateau 参数 (仅当 lr_sch='plateau' 时使用)
  # 学习率衰减因子
  # 选项: 0.1 - 0.9，常用: 0.5, 0.8, 0.9
  factor: 0.8
  
  # 触发衰减的等待轮数
  # 选项: 3, 5, 10, 15, 20
  patience: 10
  
  # CosineAnnealingLR 参数 (仅当 lr_sch='cosine' 时使用)
  # T_max: 50  # 余弦周期的最大epoch数
  # eta_min: 0.00001  # 最小学习率
  
  # AdamW 权重衰减 (可选)
  # weight_decay: 0.01
  
  # 梯度裁剪 (可选)
  # grad_clip: 1.0

# ============================================
# 数据配置
# ============================================
data:
  # 数据集路径 (支持环境变量)
  # ${TRAIN_DIR}, ${VAL_DIR}, ${TEST_DIR} 会自动替换
  file_path: "${TRAIN_DIR}/dataset.h5"
  val_path: "${VAL_DIR}/dataset.h5"
  test_path: "${TEST_DIR}/dataset.h5"
  
  # 训练样本数
  # 选项: 任意正整数，-1表示使用全部数据
  num_samples: 4096
  
  # 测试样本数
  # 选项: 任意正整数，-1表示使用全部数据
  num_test_samples: 512
  
  # 预测参数 (标签)
  # 选项:
  #   单参数: 'log_g', 'T_eff', 'M_H'
  #   多参数: 'T_eff, log_g, M_H' (逗号分隔)
  # 注意: 多参数时自动设置 num_labels = 参数数量
  param: log_g
  
  # 标签归一化方法
  # 选项:
  #   - 'minmax': Min-Max归一化到[0,1]
  #   - 'standard': 标准化 (均值0，方差1)
  #   - 'none' / null: 不归一化
  label_norm: 'minmax'

# ============================================
# 噪声配置 (数据增强)
# ============================================
noise:
  # 噪声水平
  # 选项: 0 (无噪声), 0.01, 0.02, 0.05, 0.1
  noise_level: 0

# ============================================
# 预处理器配置 (可选，高级功能)
# ============================================
# warmup:
#   # 预处理器类型
#   # 选项:
#   #   - null / 'none': 不使用预处理器
#   #   - 'zca': ZCA白化
#   #   - 'pca': PCA降维
#   #   - 'zpca': ZCA-PCA混合
#   #   - 'attention': 可学习注意力预处理
#   preprocessor: null
#   
#   # 协方差矩阵路径 (使用预处理器时必需)
#   # cov_path: "path/to/covariance.npz"
#   
#   # 冻结预处理器的epoch数
#   # 选项: 0 (不冻结), 5, 10, 20
#   # freeze_epochs: 0
#   
#   # PCA相关参数
#   # r: 128  # PCA保留的主成分数量
#   # UV: 'V'  # 使用U或V矩阵: 'U', 'V', 'UV'
#   # use_pca_mean: false  # 是否使用PCA均值中心化

# ============================================
# 可视化配置 (训练过程分析)
# ============================================
viz:
  # 是否启用可视化
  # 选项: true / false
  # 注意: 启用会增加训练时间和内存使用
  enable: true
  
  # 可视化结果保存目录
  save_dir: './results/viz'
  
  # 记录频率 (二选一)
  # 选项1: 按epoch记录
  log_every_n_epochs: 1  # 每N个epoch记录一次
  # 选项2: 按step记录 (优先级更高)
  # log_every_n_steps: 256  # 每N步记录一次
  
  # 可视化样本数
  # 选项: 64, 128, 256, 512, 1024
  num_viz_samples: 256
  
  # 追踪的batch数量
  # 选项: 1, 3, 5, 10
  max_batches_to_track: 5
  
  # 激活采样率 (采样百分比)
  # 选项: 0.05, 0.1, 0.15, 0.2 (5%-20%)
  sample_rate: 0.15
  
  # 生成预测分布GIF
  # 选项: true / false
  # 显示模型预测与真实值的分布变化
  create_distribution_gif: true
  
  # 生成激活统计GIF
  # 选项: true / false
  # 显示各层激活值的统计信息
  create_activation_gif: true
  
  # 生成注意力模式GIF
  # 选项: true / false
  # 显示注意力权重的变化
  create_attention_gif: true
  
  # 生成嵌入空间GIF
  # 选项: true / false
  # 显示样本在降维嵌入空间中的分布
  # create_embedding_gif: true
  
  # 生成共线性分析GIF
  # 选项: true / false
  # 分析嵌入向量之间的相关性
  create_collinearity_gif: true
  
  # 嵌入降维方法
  # 选项:
  #   - 'umap': UMAP (快速，内存友好，推荐)
  #   - 'tsne': t-SNE (慢，内存占用大)
  #   - 'pca': PCA (最快，线性)
  embedding_method: 'umap'
  
  # GIF动画持续时间 (毫秒/帧)
  # 选项: 100, 200, 500, 1000
  gif_duration: 500
  
  # 激活分析的层名称
  # 选项:
  #   - null: 自动选择关键层
  #   - ['layer.0', 'layer.1']: 手动指定层
  activation_layer_names: null

# ============================================
# 绘图配置
# ============================================
plotting:
  # 快速模式 (减少绘图细节以提高速度)
  # 选项: true / false
  quick_mode: false

# ============================================
# 其他高级选项
# ============================================
# 随机种子 (通过命令行 --seed 参数设置，默认42)
# seed: 42

# W&B相关 (通过命令行 -w 参数控制)
# wandb: 0  # 0=关闭, 1=开启

# 从检查点恢复训练 (通过命令行 --ckpt 参数设置)
# ckpt: null

